import React, { useMemo, useState, useEffect, useCallback, type FormEvent } from "react";
import dayjs from "dayjs";
import { useTranslation } from "react-i18next";

import "./App.css";
import "./i18n/config";
import { ParticleTextEffect } from "./components/ParticleTextEffect";
import { LavaLamp } from "./components/ui/fluid-blob";
import { LanguageSwitcher } from "./components/LanguageSwitcher";
import SimpleCountrySelector from "./components/SimpleCountrySelector";
import SimplePhoneInput from "./components/SimplePhoneInput";
import DatePicker from "./components/DatePicker";
import NetherlandsAddressValidator from "./components/NetherlandsAddressValidator";
import { InteractiveHoverButton } from "./components/ui/interactive-hover-button";
import ThankYouPage from "./components/ThankYouPage";
import { DataExporter } from "./components/DataExporter";
import { EnhancedAdminPanel } from "./components/EnhancedAdminPanel";

type TabKey = "registration" | "owner";

type RegistrationFormState = {
  firstName: string;
  lastName: string;
  country: string;
  phoneNumber: string;
  email: string;
  birthDate: string;
  city: string;
  street: string;
  postalCode: string;
  preferredFood: string;
  feedback: string;
};

type BroadcastFormState = {
  title: string;
  body: string;
};

type StatusState = {
  type: "success" | "error";
  message: string;
  details?: string;
};

type Customer = {
  id: string;
  firstName: string;
  lastName: string;
  country?: string | null;
  phoneNumber: string;
  email?: string | null;
  birthDate?: string | null;
  city?: string | null;
  street?: string | null;
  postalCode?: string | null;
  preferredFood?: string | null;
  feedback?: string | null;
  discountCode: string;
  createdAt: string;
};

type OwnerAuthState = {
  email: string;
  accessCode: string;
  password: string;
  name: string;
};

type OwnerProfile = {
  id: string;
  email: string;
  name: string;
  lastLogin?: string;
  createdAt: string;
};

type LoginSession = {
  id: string;
  deviceInfo?: string;
  ipAddress?: string;
  location?: string;
  userAgent?: string;
  browser?: string;
  os?: string;
  device?: string;
  country?: string;
  city?: string;
  latitude?: number;
  longitude?: number;
  isSuccessful: boolean;
  loginAt: string;
};

type DeviceInfo = {
  browser: string;
  browserName: string;
  browserVersion: string;
  os: string;
  osName: string;
  osVersion: string;
  device: string;
  deviceType: string;
  deviceModel: string;
  location: string;
  country: string;
  city: string;
  region: string;
  latitude: number | null;
  longitude: number | null;
  timezone: string;
  isp: string;
  ipAddress: string;
  userAgent: string;
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
  countryCode?: string;
  regionCode?: string;
  postal?: string;
  currency?: string;
  currencyName?: string;
  languages?: string;
  countryPopulation?: number;
  countryArea?: number;
  countryCapital?: string;
  continent?: string;
  isEu?: boolean;
  callingCode?: string;
  utcOffset?: string;
  connectionType?: string;
  screenResolution?: string;
  colorDepth?: number;
  pixelRatio?: number;
  language?: string;
  platform?: string;
  cookieEnabled?: boolean;
  doNotTrack?: string;
};

const defaultRegistrationState: RegistrationFormState = {
  firstName: "",
  lastName: "",
  country: "UA",
  phoneNumber: "",
  email: "",
  birthDate: "",
  city: "",
  street: "",
  postalCode: "",
  preferredFood: "",
  feedback: "",
};

const defaultBroadcastState: BroadcastFormState = {
  title: "",
  body: "",
};

const defaultOwnerAuthState: OwnerAuthState = {
  email: "",
  accessCode: "",
  password: "",
  name: "",
};

function App() {
  const { t } = useTranslation();
  const [activeTab, setActiveTab] = useState<TabKey>("registration");
  const [registrationState, setRegistrationState] = useState(defaultRegistrationState);
  const [registrationStatus, setRegistrationStatus] = useState<StatusState | null>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [addressValidation, setAddressValidation] = useState({ isValid: false, errors: [] as string[] });

  const [broadcastState, setBroadcastState] = useState(defaultBroadcastState);
  const [broadcastStatus, setBroadcastStatus] = useState<StatusState | null>(null);
  const [isBroadcasting, setIsBroadcasting] = useState(false);
  const [customers, setCustomers] = useState<Customer[]>([]);
  const [isLoadingCustomers, setIsLoadingCustomers] = useState(false);

  // –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞
  const [ownerAuthState, setOwnerAuthState] = useState(defaultOwnerAuthState);
  const [ownerProfile, setOwnerProfile] = useState<OwnerProfile | null>(null);
  const [isOwnerAuthenticating, setIsOwnerAuthenticating] = useState(false);
  const [ownerAuthStatus, setOwnerAuthStatus] = useState<StatusState | null>(null);
  const [showUnauthorizedPage, setShowUnauthorizedPage] = useState(false);
  const [currentDeviceInfo, setCurrentDeviceInfo] = useState<DeviceInfo | null>(null);
  const [loginSessions, setLoginSessions] = useState<LoginSession[]>([]);
  const [isLoadingSessions, setIsLoadingSessions] = useState(false);
  const [isAutoSyncing, setIsAutoSyncing] = useState(false);
  const [lastSyncTime, setLastSyncTime] = useState<Date | null>(null);
  const [syncInterval, setSyncInterval] = useState<NodeJS.Timeout | null>(null);
  const [previousCustomerCount, setPreviousCustomerCount] = useState(0);
  const [newCustomersCount, setNewCustomersCount] = useState(0);
  const [isMonitoringConnections, setIsMonitoringConnections] = useState(false);
  const [connectionMonitorInterval, setConnectionMonitorInterval] = useState<NodeJS.Timeout | null>(null);
  const [showThankYouPage, setShowThankYouPage] = useState(false);
  const [registeredCustomer, setRegisteredCustomer] = useState<{
    firstName: string;
    lastName: string;
    discountCode: string;
    email?: string;
    phoneNumber: string;
  } | null>(null);

  const isOwnerAuthed = useMemo(() => ownerProfile !== null, [ownerProfile]);

  function handleRegistrationChange<K extends keyof RegistrationFormState>(key: K, value: RegistrationFormState[K]) {
    console.log('App: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', { key, value });
    setRegistrationState((prev) => ({ ...prev, [key]: value }));
  }

  async function handleRegistrationSubmit(event: FormEvent<HTMLFormElement>) {
    event.preventDefault();
    setIsSubmitting(true);
    setRegistrationStatus(null);

    console.log('App: –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', registrationState);

    try {
      const response = await fetch("/api/register", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(registrationState),
      });

      const result = await response.json();

      if (response.ok) {
        setRegistrationStatus({ type: "success", message: result.message });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
        setRegisteredCustomer({
          firstName: registrationState.firstName,
          lastName: registrationState.lastName,
          discountCode: result.discountCode,
          email: registrationState.email,
          phoneNumber: registrationState.phoneNumber,
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
        setShowThankYouPage(true);
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        setRegistrationState(defaultRegistrationState);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –µ—Å–ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        if (isOwnerAuthed && ownerProfile?.email) {
          await loadCustomers(ownerProfile.email);
        }
      } else {
        setRegistrationStatus({ type: "error", message: result.message ?? t("registration.status.error") });
      }
    } catch (error) {
      console.error(error);
      setRegistrationStatus({ type: "error", message: t("registration.status.error") });
    } finally {
      setIsSubmitting(false);
    }
  }


  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞
  function handleOwnerAuthChange<K extends keyof OwnerAuthState>(key: K, value: OwnerAuthState[K]) {
    setOwnerAuthState((prev) => ({ ...prev, [key]: value }));
  }

  async function handleOwnerLogin() {
    setIsOwnerAuthenticating(true);
    setOwnerAuthStatus(null);
    setShowUnauthorizedPage(false);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
    const validCredentials = {
      email: "sushi.master.admin.2024@secure-icon.com",
      accessCode: "SUSHI-MASTER-2024-X9K7",
      password: "SushiMaster2024!@#$%^&*()_+{}|:<>?[]\\;',./"
    };

    if (
      ownerAuthState.email !== validCredentials.email ||
      ownerAuthState.accessCode !== validCredentials.accessCode ||
      ownerAuthState.password !== validCredentials.password
    ) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—à–∏–±–∫–∏ –ø—Ä–∏ –Ω–µ–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      setShowUnauthorizedPage(true);
      setOwnerAuthState(defaultOwnerAuthState);
      setIsOwnerAuthenticating(false);
      return;
    }

    try {
      const response = await fetch("/api/owner/login", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          email: ownerAuthState.email,
          accessCode: ownerAuthState.accessCode,
          password: ownerAuthState.password,
        }),
      });

      const result = await response.json();

      if (response.ok && result.success) {
        setOwnerProfile(result.owner);
        setCurrentDeviceInfo(result.deviceInfo);
        localStorage.setItem("ownerEmail", ownerAuthState.email);
        setOwnerAuthStatus({ type: "success", message: result.message });
        setOwnerAuthState(defaultOwnerAuthState);
        await loadCustomers(ownerAuthState.email);
        await loadLoginSessions();
      } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—à–∏–±–∫–∏ –ø—Ä–∏ –Ω–µ–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        setShowUnauthorizedPage(true);
        setOwnerAuthState(defaultOwnerAuthState);
      }
    } catch (error) {
      console.error(error);
      setShowUnauthorizedPage(true);
      setOwnerAuthState(defaultOwnerAuthState);
    } finally {
      setIsOwnerAuthenticating(false);
    }
  }

  function handleOwnerLogout() {
    stopAutoSync();
    stopConnectionMonitoring();
    setOwnerProfile(null);
    setOwnerAuthState(defaultOwnerAuthState);
    setOwnerAuthStatus(null);
    setCustomers([]);
    setLoginSessions([]);
    setCurrentDeviceInfo(null);
    setLastSyncTime(null);
    setShowUnauthorizedPage(false);
    localStorage.removeItem("ownerEmail");
  }

  function handleBackToGuestForm() {
    setShowUnauthorizedPage(false);
    setOwnerAuthState(defaultOwnerAuthState);
    setActiveTab("registration");
  }

  function handleCloseThankYouPage() {
    setShowThankYouPage(false);
    setRegisteredCustomer(null);
  }

  const loadCustomers = useCallback(async (token: string) => {
    setIsLoadingCustomers(true);
    try {
      const response = await fetch("/api/customers", {
        headers: {
          "x-owner-token": token,
        },
      });

      if (!response.ok) {
        throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π");
      }

      const data: Customer[] = await response.json();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –Ω–æ–≤—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      if (previousCustomerCount > 0 && data.length > previousCustomerCount) {
        const newCount = data.length - previousCustomerCount;
        setNewCustomersCount(prev => prev + newCount);
      }
      
      setPreviousCustomerCount(data.length);
      setCustomers(data);
    } catch (error) {
      console.error(error);
      setBroadcastStatus({ type: "error", message: "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π." });
    } finally {
      setIsLoadingCustomers(false);
    }
  }, [previousCustomerCount]);

  const loadLoginSessions = useCallback(async () => {
    setIsLoadingSessions(true);
    try {
      const response = await fetch("/api/owner/login-sessions", {
        headers: {
          "x-owner-token": ownerProfile?.email || "",
        },
      });

      if (!response.ok) {
        throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤—Ö–æ–¥–æ–≤");
      }

      const data: LoginSession[] = await response.json();
      setLoginSessions(data);
    } catch (error) {
      console.error(error);
    } finally {
      setIsLoadingSessions(false);
    }
  }, [ownerProfile?.email]);

  // –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  const performAutoSync = useCallback(async () => {
    if (!isOwnerAuthed || !ownerProfile?.email || isAutoSyncing) return;
    
    setIsAutoSyncing(true);
    try {
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é)
      if (!isLoadingCustomers) {
        await loadCustomers(ownerProfile.email);
      }
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤—Ö–æ–¥–æ–≤ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é)
      if (!isLoadingSessions) {
        await loadLoginSessions();
      }
      setLastSyncTime(new Date());
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:", error);
    } finally {
      setIsAutoSyncing(false);
    }
  }, [isOwnerAuthed, ownerProfile?.email, isAutoSyncing, isLoadingCustomers, isLoadingSessions, loadCustomers, loadLoginSessions]);

  // –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  const startAutoSync = useCallback(() => {
    if (syncInterval) {
      clearInterval(syncInterval);
    }
    
    const interval = setInterval(() => {
      void performAutoSync();
    }, 1000); // –ö–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    
    setSyncInterval(interval);
  }, [syncInterval, performAutoSync]);

  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  const stopAutoSync = useCallback(() => {
    if (syncInterval) {
      clearInterval(syncInterval);
      setSyncInterval(null);
    }
  }, [syncInterval]);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  const startConnectionMonitoring = useCallback(() => {
    if (connectionMonitorInterval) {
      clearInterval(connectionMonitorInterval);
    }
    
    const interval = setInterval(async () => {
      try {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
        const response = await fetch("/api/owner/current-device", {
          headers: {
            "x-owner-token": ownerProfile?.email || "",
          },
        });
        
        if (response.ok) {
          const deviceInfo = await response.json();
          setCurrentDeviceInfo(deviceInfo);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤—Ö–æ–¥–æ–≤
        await loadLoginSessions();
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:", error);
      }
    }, 2000); // –ö–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
    
    setConnectionMonitorInterval(interval);
    setIsMonitoringConnections(true);
  }, [connectionMonitorInterval, ownerProfile?.email, loadLoginSessions]);

  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
  const stopConnectionMonitoring = useCallback(() => {
    if (connectionMonitorInterval) {
      clearInterval(connectionMonitorInterval);
      setConnectionMonitorInterval(null);
    }
    setIsMonitoringConnections(false);
  }, [connectionMonitorInterval]);

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  useEffect(() => {
    const savedOwnerEmail = localStorage.getItem("ownerEmail");
    if (savedOwnerEmail && !ownerProfile) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π email —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
      if (savedOwnerEmail === "sushi.master.admin.2024@secure-icon.com") {
        setOwnerProfile({
          id: "admin-001",
          email: savedOwnerEmail,
          name: "–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
          lastLogin: new Date().toISOString(),
          createdAt: new Date().toISOString(),
        });
        void loadCustomers(savedOwnerEmail);
        void loadLoginSessions();
      } else {
        // –ï—Å–ª–∏ email –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É, –æ—á–∏—â–∞–µ–º localStorage
        localStorage.removeItem("ownerEmail");
      }
    }
  }, [ownerProfile, loadCustomers, loadLoginSessions]);

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
  useEffect(() => {
    if (isOwnerAuthed) {
      // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –≤—Ö–æ–¥–µ
      startAutoSync();
    } else {
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
      stopAutoSync();
    }

    // –û—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    return () => {
      stopAutoSync();
    };
  }, [isOwnerAuthed, startAutoSync, stopAutoSync]);

  async function handleBroadcastSubmit(event: FormEvent<HTMLFormElement>) {
    event.preventDefault();
    setIsBroadcasting(true);
    setBroadcastStatus(null);

    try {
      const response = await fetch("/api/broadcast", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-owner-token": ownerProfile?.email || "",
        },
        body: JSON.stringify(broadcastState),
      });

      const result = await response.json();

      if (response.ok) {
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Ä–∞—Å—Å—ã–ª–∫–µ
        const summary = result.summary;
        const message = summary 
          ? `${result.message} –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${summary.sent}, –ù–µ —É–¥–∞–ª–æ—Å—å: ${summary.failed}`
          : result.message;
        
        setBroadcastStatus({ 
          type: "success", 
          message,
          details: summary ? `–î–µ—Ç–∞–ª–∏: ${summary.sent} —É—Å–ø–µ—à–Ω–æ, ${summary.failed} –æ—à–∏–±–æ–∫` : undefined
        });
        setBroadcastState(defaultBroadcastState);
        if (ownerProfile?.email) {
          await loadCustomers(ownerProfile.email);
        }
      } else {
        setBroadcastStatus({ type: "error", message: result.message ?? "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É." });
      }
    } catch (error) {
      console.error(error);
      setBroadcastStatus({ type: "error", message: "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑." });
    } finally {
      setIsBroadcasting(false);
    }
  }

  return (
    <div className="app">
      <LanguageSwitcher />
      <LavaLamp className="z-0" />
      
      {/* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ */}
      {showThankYouPage && registeredCustomer && (
        <ThankYouPage
          customerData={registeredCustomer}
          onClose={handleCloseThankYouPage}
        />
      )}
      
      <div className="app__container">
        <ParticleTextEffect className="shadow-[0_28px_60px_rgba(0,84,107,0.25)]" />
        <div className="main-panel">
          <div className="main-panel__content">
        <header className="header">
          <div>
            <h1 className="header__title header__title--static">{t("app.title")}</h1>
            <p className="header__subtitle">{t("app.subtitle")}</p>
          </div>
        </header>

        <div className="tabs">
          <button
            className={`tab ${activeTab === "registration" ? "tab--active" : ""}`}
            onClick={() => setActiveTab("registration")}
          >
            {t("tabs.registration")}
          </button>
          <button className={`tab ${activeTab === "owner" ? "tab--active" : ""}`} onClick={() => {
            setActiveTab("owner");
            setShowUnauthorizedPage(false);
          }}>
            {t("tabs.owner")}
          </button>
        </div>

        {activeTab === "registration" ? (
          <section className="card card--registration">
            <h2 className="card__title">{t("registration.cardTitle")}</h2>

            <form className="form" onSubmit={handleRegistrationSubmit}>
              <div className="form__split">
                <div className="form__row">
                  <label className="form__label" htmlFor="firstName">
                    {t("registration.fields.firstName")}
                  </label>
                  <input
                    id="firstName"
                    className="form__input"
                    placeholder={t("registration.placeholders.firstName")}
                    value={registrationState.firstName}
                    onChange={(event) => handleRegistrationChange("firstName", event.target.value)}
                    required
                  />
                </div>

                <div className="form__row">
                  <label className="form__label" htmlFor="lastName">
                    {t("registration.fields.lastName")}
                  </label>
                  <input
                    id="lastName"
                    className="form__input"
                    placeholder={t("registration.placeholders.lastName")}
                    value={registrationState.lastName}
                    onChange={(event) => handleRegistrationChange("lastName", event.target.value)}
                    required
                  />
                </div>
              </div>

              <div className="form__split">
                <div className="form__row">
                  <label className="form__label" htmlFor="country">
                    {t("registration.fields.country")}
                  </label>
                  <SimpleCountrySelector
                    value={registrationState.country}
                    onChange={(countryCode) => handleRegistrationChange("country", countryCode)}
                    placeholder={t("registration.placeholders.country")}
                  />
                </div>

                <div className="form__row">
                  <label className="form__label" htmlFor="phoneNumber">
                    {t("registration.fields.phone")}
                  </label>
                  <SimplePhoneInput
                    value={registrationState.phoneNumber}
                    onChange={(phoneNumber) => handleRegistrationChange("phoneNumber", phoneNumber)}
                    countryCode={registrationState.country}
                    placeholder={t("registration.placeholders.phone")}
                    required
                  />
                  <span className="form__hint">{t("registration.hints.phone")}</span>
                </div>
              </div>

              <div className="form__split">
                <div className="form__row">
                  <label className="form__label" htmlFor="email">
                    {t("registration.fields.email")}
                  </label>
                  <input
                    id="email"
                    className="form__input"
                    placeholder={t("registration.placeholders.email")}
                    value={registrationState.email}
                    onChange={(event) => handleRegistrationChange("email", event.target.value)}
                    type="email"
                  />
                </div>
              </div>

              <div className="form__split">
                <div className="form__row">
                  <label className="form__label" htmlFor="birthDate">
                    {t("registration.fields.birthDate")}
                  </label>
                  <DatePicker
                    value={registrationState.birthDate}
                    onChange={(date) => handleRegistrationChange("birthDate", date)}
                    placeholder={t("registration.placeholders.birthDate")}
                    required
                  />
                </div>
              </div>

              <div className="form__address-section">
                <h3 className="form__section-title">{t("registration.sections.address")}</h3>
                
                <div className="form__split">
                  <div className="form__row">
                    <label className="form__label" htmlFor="city">
                      {t("registration.fields.city")}
                    </label>
                    <input
                      id="city"
                      className="form__input"
                      placeholder={t("registration.placeholders.city")}
                      value={registrationState.city}
                      onChange={(event) => handleRegistrationChange("city", event.target.value)}
                      required
                    />
                  </div>

                  <div className="form__row">
                    <label className="form__label" htmlFor="street">
                      {t("registration.fields.street")}
                    </label>
                    <input
                      id="street"
                      className="form__input"
                      placeholder={t("registration.placeholders.street")}
                      value={registrationState.street}
                      onChange={(event) => handleRegistrationChange("street", event.target.value)}
                      required
                    />
                  </div>

                  <div className="form__row">
                    <label className="form__label" htmlFor="postalCode">
                      {t("registration.fields.postalCode")}
                    </label>
                    <input
                      id="postalCode"
                      className="form__input"
                      placeholder={t("registration.placeholders.postalCode")}
                      value={registrationState.postalCode}
                      onChange={(event) => handleRegistrationChange("postalCode", event.target.value)}
                      required
                    />
                  </div>
                </div>

                <NetherlandsAddressValidator
                  city={registrationState.city}
                  street={registrationState.street}
                  postalCode={registrationState.postalCode}
                  onValidationChange={setAddressValidation}
                />

                {addressValidation.errors.length > 0 && (
                  <div className="form__hint form__hint--error">
                    {addressValidation.errors.map((error, index) => (
                      <div key={index}>{error}</div>
                    ))}
                  </div>
                )}
              </div>

              <div className="form__row">
                <label className="form__label" htmlFor="preferredFood">
                  {t("registration.fields.preferredFood")}
                </label>
                <textarea
                  id="preferredFood"
                  className="form__textarea"
                  placeholder={t("registration.placeholders.preferredFood")}
                  value={registrationState.preferredFood}
                  onChange={(event) => handleRegistrationChange("preferredFood", event.target.value)}
                />
              </div>

              {registrationStatus && (
                <div className={`status status--${registrationStatus.type}`}>
                  <span className="status__message">{registrationStatus.message}</span>
                </div>
              )}

              <div className="form__actions">
                <button className="button button--turquoise" type="reset" onClick={() => setRegistrationState(defaultRegistrationState)}>
                  {t("registration.actions.reset")}
                </button>
                <InteractiveHoverButton 
                  text={t("registration.actions.submit")}
                  className="button button--purple"
                  type="submit" 
                  disabled={isSubmitting}
                />
              </div>
            </form>
          </section>
        ) : (
          <section className="owner-section">
            {isOwnerAuthed ? (
              <EnhancedAdminPanel />
            ) : showUnauthorizedPage ? (
              <div className="card card--unauthorized">
                <div className="unauthorized-page">
                  <div className="unauthorized-icon">üö´</div>
                  <h2 className="card__title">{t("owner.unauthorized.title")}</h2>
                  <p className="unauthorized-message">
                    {t("owner.unauthorized.message")}
                  </p>
                  <p className="unauthorized-subtitle">
                    {t("owner.unauthorized.subtitle")}
                  </p>
                  <div className="unauthorized-actions">
                    <InteractiveHoverButton 
                      text={t("owner.unauthorized.backToForm")}
                      className="button button--purple"
                      onClick={handleBackToGuestForm}
                    />
                  </div>
                </div>
              </div>
            ) : (
              <div className="card card--owner">
                <h2 className="card__title">{t("owner.auth.title")}</h2>
                
                <div className="owner-auth">
                  <form className="form" onSubmit={(e) => e.preventDefault()}>
                    <div className="form__row">
                      <label className="form__label" htmlFor="ownerEmail">
                        {t("owner.auth.fields.email")}
                      </label>
                      <input
                        id="ownerEmail"
                        className="form__input"
                        type="email"
                        placeholder={t("owner.auth.placeholders.email")}
                        value={ownerAuthState.email}
                        onChange={(event) => handleOwnerAuthChange("email", event.target.value)}
                        required
                      />
                    </div>

                    <div className="form__row">
                      <label className="form__label" htmlFor="ownerAccessCode">
                        {t("owner.auth.fields.accessCode")}
                      </label>
                      <input
                        id="ownerAccessCode"
                        className="form__input"
                        type="password"
                        placeholder={t("owner.auth.placeholders.accessCode")}
                        value={ownerAuthState.accessCode}
                        onChange={(event) => handleOwnerAuthChange("accessCode", event.target.value)}
                        required
                      />
                    </div>

                    <div className="form__row">
                      <label className="form__label" htmlFor="ownerPassword">
                        {t("owner.auth.fields.password")}
                      </label>
                      <input
                        id="ownerPassword"
                        className="form__input"
                        type="password"
                        placeholder={t("owner.auth.placeholders.password")}
                        value={ownerAuthState.password}
                        onChange={(event) => handleOwnerAuthChange("password", event.target.value)}
                        required
                      />
                    </div>

                    {ownerAuthStatus && (
                      <div className={`status status--${ownerAuthStatus.type}`}>
                        <span className="status__message">{ownerAuthStatus.message}</span>
                      </div>
                    )}

                    <div className="form__actions">
                      <InteractiveHoverButton 
                        text={isOwnerAuthenticating ? t("owner.auth.actions.logging") : t("owner.auth.actions.login")}
                        className="button button--purple"
                        onClick={handleOwnerLogin}
                        disabled={isOwnerAuthenticating}
                      />
                    </div>
                  </form>
                </div>
              </div>
            ) : (
              <div className="card card--owner">
                <div className="owner-profile">
                  <h2 className="card__title">
                    {t("owner.auth.welcome", { name: ownerProfile?.name || "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä" })}
                  </h2>
                  {ownerProfile && (
                    <div className="owner-info">
                      <p>Email: {ownerProfile.email}</p>
                      {ownerProfile.lastLogin && (
                        <p>–û—Å—Ç–∞–Ω–Ω—ñ–π –≤—Ö—ñ–¥: {new Date(ownerProfile.lastLogin).toLocaleString()}</p>
                      )}
                      {currentDeviceInfo && (
                        <details className="device-info">
                          <summary className="device-info__summary" title="–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é">
                            <div className="device-info__header">
                              <span className="device-info__title">üîó –ü–æ—Ç–æ—á–Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</span>
                              <span className="device-info__expand-icon">‚ñº</span>
                            </div>
                            <span className="device-info__preview">
                              {currentDeviceInfo.browser} ‚Ä¢ {currentDeviceInfo.os} ‚Ä¢ {currentDeviceInfo.country}
                            </span>
                            <span className="device-info__hint">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –≤—Å—ñ—Ö –¥–µ—Ç–∞–ª–µ–π</span>
                          </summary>
                          
                          <div className="device-info__content">
                            <div className="device-info__section">
                              <h5>üåê –ë—Ä–∞—É–∑–µ—Ä —Ç–∞ –û–°:</h5>
                              <div className="device-info__grid">
                                <div className="device-info__item">
                                  <span className="device-info__label">–ë—Ä–∞—É–∑–µ—Ä:</span>
                                  <span className="device-info__value">{currentDeviceInfo.browser}</span>
                                </div>
                                <div className="device-info__item">
                                  <span className="device-info__label">–í–µ—Ä—Å—ñ—è –±—Ä–∞—É–∑–µ—Ä–∞:</span>
                                  <span className="device-info__value">{currentDeviceInfo.browserVersion}</span>
                                </div>
                                <div className="device-info__item">
                                  <span className="device-info__label">–û–ø–µ—Ä–∞—Ü—ñ–π–Ω–∞ —Å–∏—Å—Ç–µ–º–∞:</span>
                                  <span className="device-info__value">{currentDeviceInfo.os}</span>
                                </div>
                                <div className="device-info__item">
                                  <span className="device-info__label">–í–µ—Ä—Å—ñ—è –û–°:</span>
                                  <span className="device-info__value">{currentDeviceInfo.osVersion}</span>
                                </div>
                              </div>
                            </div>

                            <div className="device-info__section">
                              <h5>üì± –ü—Ä–∏—Å—Ç—Ä—ñ–π:</h5>
                              <div className="device-info__grid">
                                <div className="device-info__item">
                                  <span className="device-info__label">–¢–∏–ø –ø—Ä–∏—Å—Ç—Ä–æ—é:</span>
                                  <span className="device-info__value">{currentDeviceInfo.deviceType}</span>
                                </div>
                                <div className="device-info__item">
                                  <span className="device-info__label">–ú–æ–¥–µ–ª—å:</span>
                                  <span className="device-info__value">{currentDeviceInfo.deviceModel}</span>
                                </div>
                                <div className="device-info__item">
                                  <span className="device-info__label">–ü–æ–≤–Ω–∞ –Ω–∞–∑–≤–∞ –ø—Ä–∏—Å—Ç—Ä–æ—é:</span>
                                  <span className="device-info__value">{currentDeviceInfo.device}</span>
                                </div>
                              </div>
                            </div>

                            <div className="device-info__section">
                              <h5>üìç –ú—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è:</h5>
                              <div className="device-info__grid">
                                <div className="device-info__item">
                                  <span className="device-info__label">–ü–æ–≤–Ω–∞ –∞–¥—Ä–µ—Å–∞:</span>
                                  <span className="device-info__value">{currentDeviceInfo.location}</span>
                                </div>
                                <div className="device-info__item">
                                  <span className="device-info__label">–ö—Ä–∞—ó–Ω–∞:</span>
                                  <span className="device-info__value">{currentDeviceInfo.country}</span>
                                </div>
                                <div className="device-info__item">
                                  <span className="device-info__label">–ú—ñ—Å—Ç–æ:</span>
                                  <span className="device-info__value">{currentDeviceInfo.city}</span>
                                </div>
                                <div className="device-info__item">
                                  <span className="device-info__label">–†–µ–≥—ñ–æ–Ω/–û–±–ª–∞—Å—Ç—å:</span>
                                  <span className="device-info__value">{currentDeviceInfo.region}</span>
                                </div>
                                {currentDeviceInfo.latitude && currentDeviceInfo.longitude && (
                                  <div className="device-info__item">
                                    <span className="device-info__label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:</span>
                                    <span className="device-info__value">
                                      {currentDeviceInfo.latitude.toFixed(4)}, {currentDeviceInfo.longitude.toFixed(4)}
                                    </span>
                                  </div>
                                )}
                                <div className="device-info__item">
                                  <span className="device-info__label">–ß–∞—Å–æ–≤–∏–π –ø–æ—è—Å:</span>
                                  <span className="device-info__value">{currentDeviceInfo.timezone}</span>
                                </div>
                                <div className="device-info__item">
                                  <span className="device-info__label">IP –∞–¥—Ä–µ—Å–∞:</span>
                                  <span className="device-info__value">{currentDeviceInfo.ipAddress}</span>
                                </div>
                                <div className="device-info__item">
                                  <span className="device-info__label">–ü—Ä–æ–≤–∞–π–¥–µ—Ä/ISP:</span>
                                  <span className="device-info__value">{currentDeviceInfo.isp}</span>
                                </div>
                              </div>
                            </div>


                            <div className="device-info__section">
                              <h5>üîç –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ:</h5>
                              <div className="device-info__grid">
                                <div className="device-info__item">
                                  <span className="device-info__label">–¢–∏–ø –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:</span>
                                  <span className="device-info__value">
                                    {currentDeviceInfo.ipAddress === '::1' || currentDeviceInfo.ipAddress === '127.0.0.1' || currentDeviceInfo.ipAddress === 'localhost' 
                                      ? '–õ–æ–∫–∞–ª—å–Ω–∞ —Ä–æ–∑—Ä–æ–±–∫–∞' 
                                      : currentDeviceInfo.ipAddress.startsWith('192.168.') || currentDeviceInfo.ipAddress.startsWith('10.') || currentDeviceInfo.ipAddress.startsWith('172.')
                                        ? '–ü—Ä–∏–≤–∞—Ç–Ω–∞ –º–µ—Ä–µ–∂–∞'
                                        : '–ü—É–±–ª—ñ—á–Ω–∏–π —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç'
                                    }
                                  </span>
                                </div>
                                <div className="device-info__item">
                                  <span className="device-info__label">–í–µ—Ä—Å—ñ—è IP:</span>
                                  <span className="device-info__value">
                                    {currentDeviceInfo.ipAddress.includes(':') ? 'IPv6' : 'IPv4'}
                                  </span>
                                </div>
                                {currentDeviceInfo.countryCode && (
                                  <div className="device-info__item">
                                    <span className="device-info__label">–ö–æ–¥ –∫—Ä–∞—ó–Ω–∏:</span>
                                    <span className="device-info__value">{currentDeviceInfo.countryCode}</span>
                                  </div>
                                )}
                                {currentDeviceInfo.regionCode && (
                                  <div className="device-info__item">
                                    <span className="device-info__label">–ö–æ–¥ —Ä–µ–≥—ñ–æ–Ω—É:</span>
                                    <span className="device-info__value">{currentDeviceInfo.regionCode}</span>
                                  </div>
                                )}
                                {currentDeviceInfo.postal && (
                                  <div className="device-info__item">
                                    <span className="device-info__label">–ü–æ—à—Ç–æ–≤–∏–π —ñ–Ω–¥–µ–∫—Å:</span>
                                    <span className="device-info__value">{currentDeviceInfo.postal}</span>
                                  </div>
                                )}
                                {currentDeviceInfo.currency && (
                                  <div className="device-info__item">
                                    <span className="device-info__label">–í–∞–ª—é—Ç–∞:</span>
                                    <span className="device-info__value">
                                      {currentDeviceInfo.currency} {currentDeviceInfo.currencyName && `(${currentDeviceInfo.currencyName})`}
                                    </span>
                                  </div>
                                )}
                                {currentDeviceInfo.languages && (
                                  <div className="device-info__item">
                                    <span className="device-info__label">–ú–æ–≤–∏:</span>
                                    <span className="device-info__value">{currentDeviceInfo.languages}</span>
                                  </div>
                                )}
                                {currentDeviceInfo.continent && (
                                  <div className="device-info__item">
                                    <span className="device-info__label">–ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç:</span>
                                    <span className="device-info__value">{currentDeviceInfo.continent}</span>
                                  </div>
                                )}
                                {currentDeviceInfo.isEu !== undefined && (
                                  <div className="device-info__item">
                                    <span className="device-info__label">–Ñ–°:</span>
                                    <span className="device-info__value">{currentDeviceInfo.isEu ? '–¢–∞–∫' : '–ù—ñ'}</span>
                                  </div>
                                )}
                                {currentDeviceInfo.callingCode && (
                                  <div className="device-info__item">
                                    <span className="device-info__label">–¢–µ–ª–µ—Ñ–æ–Ω–Ω–∏–π –∫–æ–¥:</span>
                                    <span className="device-info__value">+{currentDeviceInfo.callingCode}</span>
                                  </div>
                                )}
                                {currentDeviceInfo.utcOffset && (
                                  <div className="device-info__item">
                                    <span className="device-info__label">UTC –∑–º—ñ—â–µ–Ω–Ω—è:</span>
                                    <span className="device-info__value">{currentDeviceInfo.utcOffset}</span>
                                  </div>
                                )}
                                {currentDeviceInfo.countryPopulation && (
                                  <div className="device-info__item">
                                    <span className="device-info__label">–ù–∞—Å–µ–ª–µ–Ω–Ω—è –∫—Ä–∞—ó–Ω–∏:</span>
                                    <span className="device-info__value">{currentDeviceInfo.countryPopulation.toLocaleString()}</span>
                                  </div>
                                )}
                                {currentDeviceInfo.countryCapital && (
                                  <div className="device-info__item">
                                    <span className="device-info__label">–°—Ç–æ–ª–∏—Ü—è:</span>
                                    <span className="device-info__value">{currentDeviceInfo.countryCapital}</span>
                                  </div>
                                )}
                              </div>
                              <details className="user-agent-details">
                                <summary>User-Agent (–Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É)</summary>
                                <code className="user-agent-code">{currentDeviceInfo.userAgent}</code>
                              </details>
                            </div>
                          </div>
                        </details>
                      )}
                    </div>
                  )}
                  <button className="button button--turquoise" onClick={handleOwnerLogout}>
                    {t("owner.auth.logout")}
                  </button>
                </div>
              </div>
            )}
          </section>
        )}
          </div>
        </div>
      </div>
    </div>
  );
}

export default App;
